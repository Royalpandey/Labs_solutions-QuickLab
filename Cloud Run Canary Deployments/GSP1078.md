
<div align="center" style="padding: 25px; background: #f2f2f2; border-radius: 15px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; box-shadow: 0px 0px 10px rgba(0,0,0,0.1);">

<h1 style="color: #2F80ED;">üöÄ Cloud Run Canary Deployments | GSP1078 </h1>


<br/>

<a href="https://www.cloudskillsboost.google/focuses/1206?parent=catalog" target="_blank" style="margin: 10px;">
  <img src="https://img.shields.io/badge/Access_Lab-4285F4?style=for-the-badge&logo=googlecloud&logoColor=white" alt="Access Lab">
</a>

<a href="https://youtu.be/ADGfVEYfUps" target="_blank" style="margin: 10px;">
  <img src="https://img.shields.io/badge/Watch_Solution_Video-FF0000?style=for-the-badge&logo=youtube&logoColor=white" alt="Watch Solution Video">
</a>

</div>

<div style="padding: 25px; background: #fff8e1; border-radius: 15px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: #333; box-shadow: 0px 0px 10px rgba(0,0,0,0.1);">

<h2 style="color: #E65100;">‚ö†Ô∏è Disclaimer:</h2>

<p style="font-size: 16px;">
This script and guide are provided for educational purposes to help you understand the lab process.  
Please open and review the script to understand each step.  
Make sure to follow Qwiklabs' Terms of Service and YouTube‚Äôs Community Guidelines.  
The goal is to enhance your learning experience ‚Äî not bypass it.
</p>

</div>

<br/>

<div style="padding: 25px; background: #f0f8ff; border-radius: 15px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: #333; box-shadow: 0px 0px 10px rgba(0,0,0,0.1);">

<h2 style="color: #2F80ED;">üåê Quick Start Guide:</h2>

<div align="center" style="margin-top: 20px;">

<!-- <a href="https://console.cloud.google.com/security/sensitive-data-protection/create/discoveryConfiguration;source=DATA_PROFILE_COVERAGE_DASHBOARD;discoveryType=4?project=" target="_blank" style="margin: 10px;">
  <img src="https://img.shields.io/badge/Open_Sensitive_Data_Protection-00C9FF?style=for-the-badge&logo=googlecloud&logoColor=white" alt="Open Sensitive Data Protection">
</a> -->

<a href="https://console.cloud.google.com/home/dashboard?project=&pli=1&cloudshell=true" target="_blank" style="margin: 10px;">
  <img src="https://img.shields.io/badge/Launch_Cloud_Shell-4285F4?style=for-the-badge&logo=googlecloud&logoColor=white" alt="Launch Cloud Shell">
</a>

</div>

<br/>

<h3>üöÄ Setup Environment using Cloud Shell:</h3>

```bash
export PROJECT_ID=$(gcloud config get-value project)
export PROJECT_NUMBER=$(gcloud projects describe $PROJECT_ID --format='value(projectNumber)')
REGION=$(gcloud compute project-info describe \
  --format="value(commonInstanceMetadata.items[google-compute-default-region])")
gcloud config set compute/region $REGION


gcloud services enable \
cloudresourcemanager.googleapis.com \
container.googleapis.com \
cloudbuild.googleapis.com \
containerregistry.googleapis.com \
run.googleapis.com \
secretmanager.googleapis.com

sleep 60


gcloud projects add-iam-policy-binding $PROJECT_ID \
--member=serviceAccount:service-$PROJECT_NUMBER@gcp-sa-cloudbuild.iam.gserviceaccount.com \
--role=roles/secretmanager.admin


curl -sS https://webi.sh/gh | sh
gh auth login
gh api user -q ".login"
GITHUB_USERNAME=$(gh api user -q ".login")
git config --global user.name "${GITHUB_USERNAME}"
git config --global user.email "${USER_EMAIL}"
echo ${GITHUB_USERNAME}
echo ${USER_EMAIL}

```

- Press **ENTER** to accept the default options. The last default you accept is to **Login with a web browser**.  
  Copy the one-time code, and then click the URL provided in the output that takes you to GitHub.  
  In GitHub, follow the prompts to connect this project to your GitHub account.  
  This involves:
  - Signing into your GitHub account  
  - Entering the one-time code when prompted  
  - Authorizing the connection to GitHub CLI


```bash

gh repo create cloudrun-progression --private 

git clone https://github.com/GoogleCloudPlatform/training-data-analyst

mkdir cloudrun-progression
cp -r /home/$USER/training-data-analyst/self-paced-labs/cloud-run/canary/*  cloudrun-progression
cd cloudrun-progression

sed -i "s/_REGION: us-central1/_REGION: $REGION/g" branch-cloudbuild.yaml
sed -i "s/_REGION: us-central1/_REGION: $REGION/g" master-cloudbuild.yaml
sed -i "s/_REGION: us-central1/_REGION: $REGION/g" tag-cloudbuild.yaml


sed -e "s/PROJECT/${PROJECT_ID}/g" -e "s/NUMBER/${PROJECT_NUMBER}/g" branch-trigger.json-tmpl > branch-trigger.json
sed -e "s/PROJECT/${PROJECT_ID}/g" -e "s/NUMBER/${PROJECT_NUMBER}/g" master-trigger.json-tmpl > master-trigger.json
sed -e "s/PROJECT/${PROJECT_ID}/g" -e "s/NUMBER/${PROJECT_NUMBER}/g" tag-trigger.json-tmpl > tag-trigger.json


git init
git config credential.helper gcloud.sh
git remote add gcp https://github.com/${GITHUB_USERNAME}/cloudrun-progression
git branch -m master
git add . && git commit -m "initial commit"
git push gcp master


gcloud builds submit --tag gcr.io/$PROJECT_ID/hello-cloudrun
gcloud run deploy hello-cloudrun \
--image gcr.io/$PROJECT_ID/hello-cloudrun \
--platform managed \
--region $REGION \
--tag=prod -q


PROD_URL=$(gcloud run services describe hello-cloudrun --platform managed --region $REGION --format=json | jq --raw-output ".status.url")
echo $PROD_URL
curl -H "Authorization: Bearer $(gcloud auth print-identity-token)" $PROD_URL


gcloud builds connections create github cloud-build-connection --project=$PROJECT_ID  --region=$REGION 

gcloud builds connections describe cloud-build-connection --region=$REGION 


```

- Click Continue. Install the Cloud Build GitHub App in your GitHub account.

- Choose Only select repositories, and then click Select repositories and select the cloudrun-progression repository.

**For Better Understading Follow the Video**



```bash

gcloud builds repositories create cloudrun-progression \
     --remote-uri="https://github.com/${GITHUB_USERNAME}/cloudrun-progression.git" \
     --connection="cloud-build-connection" --region=$REGION


gcloud builds triggers create github --name="branch" \
   --repository=projects/$PROJECT_ID/locations/$REGION/connections/cloud-build-connection/repositories/cloudrun-progression \
   --build-config='branch-cloudbuild.yaml' \
   --service-account=projects/$PROJECT_ID/serviceAccounts/$PROJECT_NUMBER-compute@developer.gserviceaccount.com \
   --region=$REGION \
   --branch-pattern='[^(?!.*master)].*'


git checkout -b new-feature-1


sed -i "s/v1.0/v1.1/g" app.py

git add . && git commit -m "updated" && git push gcp new-feature-1

BRANCH_URL=$(gcloud run services describe hello-cloudrun --platform managed --region $REGION --format=json | jq --raw-output ".status.traffic[] | select (.tag==\"new-feature-1\")|.url")
echo $BRANCH_URL


gcloud builds triggers create github --name="master" \
   --repository=projects/$PROJECT_ID/locations/$REGION/connections/cloud-build-connection/repositories/cloudrun-progression \
   --build-config='master-cloudbuild.yaml' \
   --service-account=projects/$PROJECT_ID/serviceAccounts/$PROJECT_NUMBER-compute@developer.gserviceaccount.com  \
   --region=$REGION \
   --branch-pattern='master'


git checkout master
git merge new-feature-1
git push gcp master


CANARY_URL=$(gcloud run services describe hello-cloudrun --platform managed --region $REGION --format=json | jq --raw-output ".status.traffic[] | select (.tag==\"canary\")|.url")
echo $CANARY_URL

curl -H "Authorization: Bearer $(gcloud auth print-identity-token)" $CANARY_URL




gcloud builds triggers create github --name="tag" \
   --repository=projects/$PROJECT_ID/locations/$REGION/connections/cloud-build-connection/repositories/cloudrun-progression \
   --build-config='tag-cloudbuild.yaml' \
   --service-account=projects/$PROJECT_ID/serviceAccounts/$PROJECT_NUMBER-compute@developer.gserviceaccount.com  \
   --region=$REGION \
   --tag-pattern='.*'


git tag 1.1
git push gcp 1.1
```

<p style="font-size: 15px; color: #555;"><i>üëâ This runs the script to set up your environment. It provisions resources and configures as needed.</i></p>

<hr style="border: none; height: 1px; background: #ddd; margin: 30px 0;">



<div align="left" style="padding: 25px; background: linear-gradient(135deg, #00C9FF, #92FE9D); border-radius: 15px; color: #333; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; box-shadow: 0px 0px 12px rgba(0,0,0,0.1);">

<h2 style="margin-bottom: 10px;">üéâ Lab Completed!</h2>

<p style="font-size: 18px; margin-top: 0px;">You've successfully completed the lab! Great job on working through the entire process! üöÄ</p>

</div>


<div align="center" style="padding: 20px; background-color: #f9f9f9; border-radius: 12px; box-shadow: 0px 0px 10px rgba(0,0,0,0.1);">

<h2 style="color: #2F80ED; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">üåü Stay Connected!</h2>

<p style="font-size: 16px; color: #555;">Follow us and never miss an update üöÄ</p>

<a href="https://www.instagram.com/quicklab_insta/" target="_blank" style="margin: 10px;">
  <img src="https://img.shields.io/badge/Instagram-E4405F?style=for-the-badge&logo=instagram&logoColor=white" alt="Instagram">
</a>

<a href="https://t.me/quiccklab" target="_blank" style="margin: 10px;">
  <img src="https://img.shields.io/badge/Join_Telegram-229ED9?style=for-the-badge&logo=telegram&logoColor=white" alt="Telegram Channel">
</a>

<a href="https://t.me/Quicklabchat" target="_blank" style="margin: 10px;">
  <img src="https://img.shields.io/badge/Discussion_Group-229ED9?style=for-the-badge&logo=telegram&logoColor=white" alt="Discussion Group">
</a>

<a href="https://discord.gg/7fAVf4USZn" target="_blank" style="margin: 10px;">
  <img src="https://img.shields.io/badge/Join_Discord-5865F2?style=for-the-badge&logo=discord&logoColor=white" alt="Discord Server">
</a>

<a href="https://www.linkedin.com/company/quicklab-linkedin/" target="_blank" style="margin: 10px;">
  <img src="https://img.shields.io/badge/Follow_on_LinkedIn-0077B5?style=for-the-badge&logo=linkedin&logoColor=white" alt="LinkedIn Page">
</a>

<a href="https://x.com/quicklab7" target="_blank" style="margin: 10px;">
  <img src="https://img.shields.io/badge/Follow_on_X-000000?style=for-the-badge&logo=x&logoColor=white" alt="Twitter/X">
</a>

</div>


<div align="center" style="padding: 25px; background: linear-gradient(135deg, #2F80ED, #56CCF2); border-radius: 15px; color: white; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; box-shadow: 0px 0px 15px rgba(0,0,0,0.2);">

<h2 style="margin-bottom: 10px;">üöÄ Keep Up the Great Work!</h2>

<p style="font-size: 18px; margin-top: 0px;">Continue your amazing learning journey with us. üåü</p>

<br/>

<a href="https://www.youtube.com/@quick_lab" target="_blank" style="text-decoration: none;">
  <img src="https://img.shields.io/badge/Subscribe-QUICKLAB‚òÅÔ∏è-FF0000?style=for-the-badge&logo=youtube&logoColor=white" alt="Subscribe to Quicklab">
</a>

</div>
